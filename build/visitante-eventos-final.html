<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos P√∫blicos - Portal Visitante</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --claut-red: #C7252B;
            --claut-dark: #1e293b;
            --porsche-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--porsche-font);
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #334155;
        }

        .header {
            background: linear-gradient(135deg, var(--claut-red) 0%, #A01E24 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(199, 37, 43, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .visitor-notice {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
        }

        .restriction-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #856404;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-bar {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            text-align: center;
        }

        .stat-item h3 {
            color: var(--claut-red);
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .stat-item p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .eventos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .evento-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .evento-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--claut-red);
        }

        .evento-preview-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--claut-red);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 2;
        }

        .evento-fecha-badge {
            background: linear-gradient(135deg, var(--claut-red), #A01E24);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .fecha-dia {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .fecha-mes {
            font-size: 0.85rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .evento-content {
            padding: 1.5rem;
        }

        .evento-titulo {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--claut-dark);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .evento-tipo {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.75rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .evento-detalles {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .evento-detalle {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #64748b;
        }

        .evento-detalle i {
            width: 16px;
            margin-right: 0.5rem;
            color: var(--claut-red);
        }

        .evento-restricted {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: #92400e;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--claut-red);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            margin: 2rem 0;
        }

        .back-link {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.8rem 1.5rem;
            background: var(--claut-red);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            background: #A01E24;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .eventos-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-calendar-alt"></i> Eventos P√∫blicos</h1>
            <p>Vista previa limitada de eventos disponibles</p>
            <div class="visitor-notice">
                <i class="fas fa-info-circle"></i>
                <strong>Acceso de visitante:</strong> Solo informaci√≥n b√°sica disponible.
                Para registro e informaci√≥n completa,
                <a href="./pages/sign-up.html" style="color: #fef3c7; text-decoration: underline;">reg√≠strate aqu√≠</a>.
            </div>
        </div>
    </div>

    <div class="container">
        <div class="restriction-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Vista previa limitada:</strong> Los visitantes solo pueden ver informaci√≥n b√°sica de eventos.
            El registro y detalles completos requieren autenticaci√≥n.
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <h3 id="totalEventos">0</h3>
                <p>Eventos</p>
            </div>
            <div class="stat-item">
                <h3 id="eventosProximos">0</h3>
                <p>Pr√≥ximos</p>
            </div>
            <div class="stat-item">
                <h3 id="participantesTotales">0</h3>
                <p>Participantes</p>
            </div>
        </div>

        <div id="eventosContainer" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Cargando eventos desde la base de datos...</p>
        </div>

        <div style="text-align: center;">
            <a href="./visitante.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Volver al Portal
            </a>
        </div>
    </div>

    <script>
        // Variables globales
        let eventosData = [];

        // Cargar eventos al inicializar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÖ Cargando eventos desde la base de datos...');
            loadEventos();
        });

        async function loadEventos() {
            const container = document.getElementById('eventosContainer');

            try {
                // Intentar m√∫ltiples endpoints de la API
                const endpoints = [
                    './api/eventos.php?action=listar',
                    './api/eventos.php'
                ];

                let response = null;
                let data = null;

                for (const endpoint of endpoints) {
                    try {
                        console.log(`üîÑ Intentando endpoint: ${endpoint}`);
                        response = await fetch(endpoint);

                        if (response.ok) {
                            const text = await response.text();
                            console.log(`‚úÖ Respuesta del servidor (${endpoint}):`, text.substring(0, 200));

                            try {
                                data = JSON.parse(text);
                                console.log(`‚úÖ Datos parseados exitosamente desde: ${endpoint}`, {
                                    success: data.success,
                                    hasData: !!data.data,
                                    dataType: Array.isArray(data.data) ? 'array' : typeof data.data,
                                    dataLength: data.data ? data.data.length : 0
                                });
                                break;
                            } catch (parseError) {
                                console.log(`‚ùå Error al parsear JSON desde ${endpoint}:`, parseError);
                                console.log('üìÑ Texto crudo:', text);
                                continue;
                            }
                        } else {
                            console.log(`‚ùå HTTP Error ${response.status} from ${endpoint}`);
                        }
                    } catch (fetchError) {
                        console.log(`‚ùå Error de conexi√≥n con ${endpoint}:`, fetchError);
                        continue;
                    }
                }

                if (!data) {
                    throw new Error('No se pudo conectar con ning√∫n endpoint de la API');
                }

                // Procesar datos seg√∫n el formato de la API de eventos
                let eventos = [];

                if (data.success && Array.isArray(data.data)) {
                    eventos = data.data;
                    console.log('‚úÖ Datos encontrados en data.data:', eventos.length);
                } else if (data.success && data.eventos) {
                    eventos = data.eventos;
                    console.log('‚úÖ Datos encontrados en data.eventos:', eventos.length);
                } else if (Array.isArray(data)) {
                    eventos = data;
                    console.log('‚úÖ Datos como array directo:', eventos.length);
                } else if (data.eventos && Array.isArray(data.eventos)) {
                    eventos = data.eventos;
                    console.log('‚úÖ Datos encontrados en eventos:', eventos.length);
                } else {
                    console.log('‚ö†Ô∏è Formato de datos inesperado:', data);
                    console.log('Claves disponibles:', Object.keys(data));
                    eventos = [];
                }

                // Filtrar solo informaci√≥n b√°sica para visitantes (solo eventos futuros y activos)
                const ahora = new Date();
                const eventosPublicos = eventos.filter(evento => {
                    const fechaEvento = new Date(evento.fecha_inicio || evento.fecha || evento.fecha_evento);
                    // Solo eventos futuros y con estado activo
                    return fechaEvento >= ahora && (evento.estado === 'activo' || evento.estado === 'publicado' || !evento.estado);
                });

                console.log(`üîç Eventos totales: ${eventos.length}, Eventos p√∫blicos futuros: ${eventosPublicos.length}`);
                if (eventos.length > 0 && eventosPublicos.length === 0) {
                    console.log('‚ÑπÔ∏è Hay eventos pero ninguno cumple los criterios (futuros + activos)');
                    console.log('üìÖ Primer evento fecha:', eventos[0].fecha_inicio || eventos[0].fecha);
                    console.log('üè∑Ô∏è Primer evento estado:', eventos[0].estado);
                }

                console.log(`üìä Total de eventos: ${eventos.length}, P√∫blicos: ${eventosPublicos.length}`);

                if (eventosPublicos.length > 0) {
                    eventosData = eventosPublicos;
                    renderEventos(eventosPublicos);
                    updateStats(eventosPublicos);
                } else {
                    // Si no hay eventos futuros, mostrar todos los eventos pero con indicaci√≥n
                    console.log('‚ÑπÔ∏è No hay eventos futuros, mostrando todos los eventos disponibles');
                    if (eventos.length > 0) {
                        eventosData = eventos;
                        renderEventos(eventos);
                        updateStats(eventos);

                        // Agregar aviso sobre eventos pasados
                        const container = document.getElementById('eventosContainer');
                        const avisoEventosPasados = `
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; text-align: center; color: #92400e;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Nota:</strong> Se muestran eventos pasados ya que no hay eventos futuros programados.
                            </div>
                        `;
                        container.innerHTML = avisoEventosPasados + container.innerHTML;
                    } else {
                        showNoData();
                    }
                }

            } catch (error) {
                console.error('‚ùå Error al cargar eventos:', error);
                showError(error.message);
            }
        }

        function renderEventos(eventos) {
            const container = document.getElementById('eventosContainer');

            if (!eventos || eventos.length === 0) {
                showNoData();
                return;
            }

            const html = eventos.map(evento => createEventoCard(evento)).join('');
            container.innerHTML = `<div class="eventos-grid">${html}</div>`;
        }

        function createEventoCard(evento) {
            // Mapear campos seg√∫n la estructura de la API de eventos
            const titulo = evento.titulo || evento.nombre || evento.title || 'Evento sin t√≠tulo';
            const descripcion = evento.descripcion || evento.description || '';
            const fecha = evento.fecha_inicio || evento.fecha || evento.fecha_evento || new Date().toISOString();
            const fechaFin = evento.fecha_fin || null;
            const ubicacion = evento.ubicacion || evento.lugar || evento.location || 'Por definir';
            const tipo = evento.tipo || evento.categoria || evento.type || 'Evento';
            const modalidad = evento.modalidad || evento.modality || 'Presencial';
            const participantes = evento.registrados || evento.capacidad_actual || evento.participantes_registrados || evento.participants || 0;
            const capacidad = evento.capacidad_maxima || evento.cupo_maximo || 100;

            // Procesar fecha
            const fechaEvento = new Date(fecha);
            const dia = fechaEvento.getDate();
            const mes = fechaEvento.toLocaleDateString('es-MX', { month: 'short' });

            // Extraer hora de la fecha si no viene separada
            const horaCompleta = fechaEvento.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
            const hora = evento.hora || evento.hora_inicio || horaCompleta;

            // Truncar descripci√≥n para vista previa muy limitada
            const descripcionPreview = descripcion.length > 50 ?
                descripcion.substring(0, 50) + '...' : descripcion || 'Vista previa no disponible';

            return `
                <div class="evento-card">
                    <div class="evento-preview-badge">Vista Previa</div>

                    <div class="evento-fecha-badge">
                        <div class="fecha-dia">${dia}</div>
                        <div class="fecha-mes">${mes.toUpperCase()}</div>
                    </div>

                    <div class="evento-content">
                        <div class="evento-titulo">${titulo}</div>

                        <div class="evento-tipo">
                            <i class="fas fa-${getTipoIcon(tipo)}"></i>
                            ${tipo}
                        </div>

                        <div class="evento-detalles">
                            <div class="evento-detalle">
                                <i class="fas fa-clock"></i>
                                ${hora}
                            </div>
                            <div class="evento-detalle">
                                <i class="fas fa-map-marker-alt"></i>
                                ${ubicacion.length > 30 ? ubicacion.substring(0, 30) + '...' : ubicacion}
                            </div>
                            <div class="evento-detalle">
                                <i class="fas fa-${modalidad === 'Online' ? 'video' : modalidad === 'H√≠brido' ? 'users' : 'building'}"></i>
                                ${modalidad}
                            </div>
                            ${participantes > 0 ? `
                                <div class="evento-detalle">
                                    <i class="fas fa-users"></i>
                                    ${participantes} registrados
                                </div>
                            ` : ''}
                        </div>

                        <div class="evento-restricted">
                            <i class="fas fa-lock"></i>
                            <strong>Acceso restringido:</strong> Informaci√≥n completa y registro solo para usuarios autenticados
                        </div>
                    </div>
                </div>
            `;
        }

        function getTipoIcon(tipo) {
            const iconMap = {
                'Conferencia': 'microphone-alt',
                'Taller': 'tools',
                'Workshop': 'tools',
                'Webinar': 'video',
                'Seminario': 'chalkboard-teacher',
                'Networking': 'handshake',
                'Mesa Redonda': 'comments',
                'Capacitaci√≥n': 'graduation-cap',
                'Reuni√≥n': 'users'
            };

            return iconMap[tipo] || 'calendar-alt';
        }

        function updateStats(eventos) {
            const ahora = new Date();
            const eventosProximos = eventos.filter(evento => {
                const fechaEvento = new Date(evento.fecha_inicio || evento.fecha || evento.fecha_evento);
                return fechaEvento > ahora;
            });

            const totalParticipantes = eventos.reduce((sum, evento) =>
                sum + (parseInt(evento.capacidad_actual) || parseInt(evento.registrados) || parseInt(evento.participantes_registrados) || parseInt(evento.participants) || 0), 0
            );

            document.getElementById('totalEventos').textContent = eventos.length;
            document.getElementById('eventosProximos').textContent = eventosProximos.length;
            document.getElementById('participantesTotales').textContent = totalParticipantes;

            console.log(`üìä Stats actualizadas - Total: ${eventos.length}, Pr√≥ximos: ${eventosProximos.length}, Participantes: ${totalParticipantes}`);
        }

        function showNoData() {
            const container = document.getElementById('eventosContainer');
            container.innerHTML = `
                <div class="error-message" style="background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1;">
                    <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem; color: #94a3b8;"></i>
                    <h3>No hay eventos pr√≥ximos</h3>
                    <p>Actualmente no hay eventos programados para fechas futuras.</p>
                </div>
            `;
            document.getElementById('totalEventos').textContent = '0';
            document.getElementById('eventosProximos').textContent = '0';
            document.getElementById('participantesTotales').textContent = '0';
        }

        function showError(message) {
            const container = document.getElementById('eventosContainer');
            container.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>Error al cargar eventos</h3>
                    <p>${message}</p>
                    <button onclick="loadEventos()" class="back-link" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> Intentar de nuevo
                    </button>
                </div>
            `;
            document.getElementById('totalEventos').textContent = '0';
            document.getElementById('eventosProximos').textContent = '0';
            document.getElementById('participantesTotales').textContent = '0';
        }
    </script>
</body>
</html>