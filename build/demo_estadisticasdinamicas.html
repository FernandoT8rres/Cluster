<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Estadísticas Dinámicas - Clúster</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #C7252B;
            --primary-dark: #A01E23;
            --primary-light: #D94449;
            --secondary-color: #2C3E50;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --info-color: #3498DB;
            --danger-color: #E74C3C;
            --card-shadow: 0 4px 20px rgba(199, 37, 43, 0.1);
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }

        .modal-backdrop { backdrop-filter: blur(5px); }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            filter: blur(60px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border: 1px solid rgba(199, 37, 43, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .stat-card.blue::before { background: linear-gradient(to bottom, #3498DB, #5DADE2); }
        .stat-card.green::before { background: linear-gradient(to bottom, #27AE60, #58D68D); }
        .stat-card.orange::before { background: linear-gradient(to bottom, #F39C12, #F8C471); }
        .stat-card.purple::before { background: linear-gradient(to bottom, #9B59B6, #BB8FCE); }
        .stat-card.red::before { background: linear-gradient(to bottom, #E74C3C, #F1948A); }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(199, 37, 43, 0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .config-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(199, 37, 43, 0.1);
            outline: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(199, 37, 43, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ECC71);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #E67E22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #C0392B);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .config-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .config-table th,
        .config-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .config-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .config-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 60px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option.selected {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .icon-option {
            width: 50px;
            height: 50px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-option.selected {
            border-color: var(--primary-color);
            background: rgba(199, 37, 43, 0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.info { background: var(--info-color); }

        .preview-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .query-builder {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 1.5rem; }
        }

        /* Porsche-inspired Design System - Responsive Sidebar */
        :root {
            /* Primary Colors - Inspired by Porsche */
            --porsche-black: #1a1a1a;
            --porsche-charcoal: #2d2d2d;
            --porsche-silver: #8a8a8a;
            --porsche-white: #ffffff;
            --porsche-light-gray: #f5f5f5;
            --porsche-accent: #c9302c;
            /* Typography */
            --porsche-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --porsche-radius-lg: 12px;
        }

        /* === RESPONSIVE SIDEBAR FUNCTIONALITY === */

        /* Porsche-inspired Sidebar */
        .porsche-sidebar {
            background: linear-gradient(180deg, var(--porsche-black) 0%, var(--porsche-charcoal) 100%) !important;
            border-radius: var(--porsche-radius-lg) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
            height: calc(100vh - 2rem) !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            font-family: var(--porsche-font) !important;
        }

        .porsche-sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .porsche-sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .porsche-sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .porsche-sidebar .porsche-logo {
            color: var(--porsche-white) !important;
            font-weight: 700 !important;
            font-size: 1.5rem !important;
        }

        .porsche-nav-item {
            color: rgba(255, 255, 255, 0.8) !important;
            border-radius: 12px !important;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;
            font-weight: 500 !important;
        }

        .porsche-nav-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            color: var(--porsche-white) !important;
            transform: translateX(4px) !important;
        }

        .porsche-nav-item.active {
            background: rgba(199, 37, 43, 0.2) !important;
            color: var(--porsche-white) !important;
            border-left: 3px solid #C7252B !important;
        }

        /* Sidebar Overlay */
        .sidenav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 998;
            backdrop-filter: blur(4px);
        }

        .sidenav-overlay.show {
            opacity: 1;
            visibility: visible;
            z-index: 998;
        }

        /* Close button styling */
        #sidebarCloseBtn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        #sidebarCloseBtn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        /* Sidebar always retractable - All screens */
        .porsche-sidebar {
            transform: translateX(-100%) !important;
            z-index: 999 !important;
            margin: 0 !important;
            top: 0 !important;
            left: 0 !important;
            border-radius: 0 !important;
            width: 280px !important;
            max-width: 280px !important;
            height: 100vh !important;
            position: fixed !important;
            display: block !important;
        }

        .porsche-sidebar.sidenav-show {
            transform: translateX(0) !important;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        /* Main content always without sidebar margin */
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }

        .container {
            margin-left: 0 !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        /* Desktop adjustments */
        @media (min-width: 1280px) {
            .container {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
        }

        /* Force sidebar behavior on all screens - Override any conflicting styles */
        .porsche-sidebar.sidebar-enhanced {
            transform: translateX(-100%) !important;
        }

        .porsche-sidebar.sidebar-enhanced.sidenav-show {
            transform: translateX(0) !important;
        }

        /* Override any Tailwind classes that might interfere */
        aside.porsche-sidebar {
            left: 0 !important;
            margin-left: 0 !important;
        }

        /* Ensure hamburger button works on all screens */
        @media (min-width: 1280px) {
            [sidenav-trigger] {
                display: block !important;
                visibility: visible !important;
            }
        }

        /* Hamburger button styling */
        .hamburger-btn {
            transition: all 0.3s ease;
        }

        .hamburger-btn:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidenav-overlay" id="sidenavOverlay"></div>
    <!-- Porsche Sidebar -->
    <aside id="porscheSidebar"
        class="porsche-sidebar sidebar-enhanced fixed inset-y-0 flex-wrap items-center justify-between block w-full p-0 m-0 overflow-y-auto overflow-x-hidden antialiased transition-transform duration-200 border-0 max-w-64 ease-nav-brand z-990"
        aria-expanded="false">
        <div class="h-48 py-6 relative mb-4">
            <!-- Botón de cerrar para todas las pantallas -->
            <button class="absolute top-4 right-4 text-white hover:text-gray-300 text-2xl z-50 p-3 bg-black/30 rounded-lg hover:bg-black/50 transition-all"
                    id="sidebarCloseBtn"
                    sidenav-close
                    aria-label="Cerrar menú">
                <i class="fas fa-times"></i>
            </button>
            <a class="porsche-logo block px-6 py-4 m-0 text-center whitespace-nowrap" href="dashboard.html"
              target="_blank">
                <img src="../assets/img/apple-icon.png"
                  class="block mx-auto h-32 w-32 max-w-full transition-all duration-200 ease-nav-brand mb-4"
                  alt="main_logo" />
                <span class="block text-lg transition-all duration-200 ease-nav-brand text-white font-semibold mb-4">Clúster Admin</span>
            </a>
        </div>
        <hr class="h-px mt-4 mb-4 bg-transparent bg-gradient-to-r from-transparent via-black/40 to-transparent" />
        <div class="items-center block w-auto max-h-screen overflow-auto h-sidenav grow basis-full">
            <ul class="flex flex-col pl-0 mb-0 pt-4">
                <!-- Dashboard -->
                <li class="mt-2 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="dashboard.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-tachometer-alt text-blue-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Dashboard</span>
                    </a>
                </li>
                <!-- admin panel -->
                <li class="mt-2 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="admin-panel.html?login=success">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-tachometer-alt text-green-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Panel Administrador</span>
                    </a>
                </li>
                <!-- Usuarios -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="gestionar_usuarios.php">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-users text-green-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Usuarios</span>
                    </a>
                </li>
                <!-- Empresas -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_empresas.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-building text-purple-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Empresas</span>
                    </a>
                </li>
                <!-- Descuentos -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_descuentos.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-tags text-red-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Descuentos</span>
                    </a>
                </li>
                <!-- Comités -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_comite.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-users text-blue-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Comités</span>
                    </a>
                </li>
                <!-- Eventos -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_evento.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-calendar text-orange-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Eventos</span>
                    </a>
                </li>
                <!-- Gestión Gráfico -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_gestion_grafico.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-chart-bar text-teal-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Gestión Gráfico</span>
                    </a>
                </li>
                <!-- Estadísticas Dinámicas - ACTIVE -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item active py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_estadisticasdinamicas.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-chart-line text-indigo-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Estadísticas Dinámicas</span>
                    </a>
                </li>
                <!-- Visitantes -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="demo_visitante.html">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-eye text-cyan-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Visitantes</span>
                    </a>
                </li>
                <!-- Banners -->
                <li class="mt-0.5 w-full">
                    <a class="porsche-nav-item py-2.5 text-sm ease-nav-brand my-0 mx-4 flex items-center whitespace-nowrap px-4 transition-colors rounded-lg"
                        href="admin/banner-admin-mejorado.php">
                        <div class="shadow-md mr-3 flex h-8 w-8 items-center justify-center rounded-lg bg-white">
                            <i class="fas fa-images text-pink-500"></i>
                        </div>
                        <span class="ml-1 duration-300 opacity-100">Banners</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>

    <div class="main-content">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-600 to-red-700 text-white shadow-lg" style="background: linear-gradient(135deg, #C7252B 0%, #A01E24 100%);">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button class="hamburger-btn bg-white/10 hover:bg-white/20 p-3 rounded-lg mr-4"
                            sidenav-trigger
                            id="hamburgerBtn"
                            aria-label="Abrir menú">
                        <i class="fas fa-bars text-white"></i>
                    </button>
                    <div>
                        <h1 class="text-3xl font-bold">
                            <i class="fas fa-chart-line mr-3"></i>Estadísticas Dinámicas
                        </h1>
                        <p class="text-red-200 mt-1">Configuración Avanzada del Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='dashboard.html'" class="bg-white text-red-600 px-4 py-2 rounded-lg hover:bg-red-50 transition">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </button>
                    <button onclick="previsualizarDashboard()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-eye mr-2"></i>Previsualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Estadísticas -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Estadísticas Activas</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalEstadisticas">0</p>
                    </div>
                    <i class="fas fa-chart-bar text-3xl" style="color: #C7252B;"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Consultas Correctas</p>
                        <p class="text-2xl font-bold text-gray-800" id="consultasCorrectas">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Con Errores</p>
                        <p class="text-2xl font-bold text-gray-800" id="consultasError">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">Última Act.</p>
                        <p class="text-sm font-medium text-gray-800" id="ultimaActualizacion">Ahora</p>
                    </div>
                    <i class="fas fa-clock text-3xl text-blue-500"></i>
                </div>
            </div>
        </div>

        <!-- Controles principales -->
        <div class="flex justify-center space-x-4 mb-6">
            <button onclick="actualizarVistaPrevia()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center">
                <i class="fas fa-sync-alt mr-2"></i>Actualizar
            </button>
            <button onclick="abrirModalNueva()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                <i class="fas fa-plus mr-2"></i>Nueva Estadística
            </button>
            <button onclick="resetearEstadisticas()" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition flex items-center">
                <i class="fas fa-refresh mr-2"></i>Resetear Datos
            </button>
            <button onclick="corregirConsultas()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition flex items-center" style="background-color: #C7252B;">
                <i class="fas fa-tools mr-2"></i>Corregir SQL
            </button>
        </div>

    <div class="container mx-auto px-4 max-w-7xl">

        <!-- Vista Previa de Estadísticas Actuales -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-dashboard mr-3" style="color: #C7252B;"></i>Estadísticas del Dashboard
                </h2>
                <div class="flex space-x-2">
                    <button onclick="toggleModoEdicion()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition" id="btnModoEdicion">
                        <i class="fas fa-edit mr-2"></i>Modo Edición
                    </button>
                </div>
            </div>
            
            <div id="estadisticasPreview" class="stats-grid">
                <!-- Se cargarán dinámicamente -->
            </div>
            
            <!-- Panel de edición rápida (oculto inicialmente) -->
            <div id="panelEdicionRapida" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg" style="display: none;">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-yellow-800">
                        <i class="fas fa-magic mr-2"></i>Edición Rápida de Estadísticas
                    </h3>
                    <button onclick="salirModoEdicion()" class="text-yellow-600 hover:text-yellow-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-yellow-700 mb-4">
                    Haz clic en cualquier estadística para editarla directamente, o arrastra para reordenar.
                </p>
                
                <div class="flex space-x-3">
                    <button onclick="modificarTodasLasEstadisticas()" class="btn btn-info btn-sm">
                        <i class="fas fa-cogs mr-2"></i>Modificar Todas
                    </button>
                    <button onclick="resetearEstadisticasDefecto()" class="btn btn-warning btn-sm">
                        <i class="fas fa-undo mr-2"></i>Restaurar Predeterminadas
                    </button>
                    <button onclick="aplicarCambios()" class="btn btn-success btn-sm">
                        <i class="fas fa-check mr-2"></i>Aplicar Cambios
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuraciones Existentes -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-cogs mr-3" style="color: #C7252B;"></i>Configuraciones de Estadísticas
                </h2>
                <button onclick="abrirModalNueva()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition" style="background-color: #C7252B;">
                    <i class="fas fa-plus mr-2"></i>Nueva Estadística
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="config-table" id="tablaConfiguraciones">
                    <thead>
                        <tr>
                            <th>Posición</th>
                            <th>Título</th>
                            <th>Icono</th>
                            <th>Color</th>
                            <th>Formato</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaConfiguracionesBody">
                        <!-- Se carga dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    </div>

    <!-- Modal para Nueva/Editar Estadística -->
    <div id="modalConfiguracion" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 modal-backdrop" style="display: none;">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full slide-in max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h3 id="modalTitulo" class="text-xl font-bold text-gray-800">Nueva Estadística</h3>
                        <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6 overflow-y-auto max-h-[70vh]">
                    <form id="formularioConfiguracion">
                <input type="hidden" id="configId" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre Interno *</label>
                        <input type="text" id="configNombre" class="form-control" 
                               placeholder="ej: total_usuarios" required>
                        <small class="text-gray-500">Identificador único (solo letras, números y guiones bajos)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Título Visible *</label>
                        <input type="text" id="configTitulo" class="form-control" 
                               placeholder="ej: Total de Usuarios" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <input type="text" id="configDescripcion" class="form-control" 
                           placeholder="Descripción de la estadística">
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Icono</label>
                        <input type="text" id="configIcono" class="form-control" 
                               placeholder="fas fa-users" readonly>
                        <div class="icon-grid" id="iconGrid">
                            <!-- Se cargan dinámicamente -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <div class="color-options">
                            <div class="color-option" data-color="blue" style="background: linear-gradient(135deg, #3498DB, #5DADE2);"></div>
                            <div class="color-option" data-color="green" style="background: linear-gradient(135deg, #27AE60, #58D68D);"></div>
                            <div class="color-option" data-color="orange" style="background: linear-gradient(135deg, #F39C12, #F8C471);"></div>
                            <div class="color-option" data-color="purple" style="background: linear-gradient(135deg, #9B59B6, #BB8FCE);"></div>
                            <div class="color-option" data-color="red" style="background: linear-gradient(135deg, #E74C3C, #F1948A);"></div>
                        </div>
                        <input type="hidden" id="configColor" value="blue">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Formato de Visualización</label>
                        <select id="configFormato" class="form-control">
                            <option value="number">Número</option>
                            <option value="percentage">Porcentaje</option>
                            <option value="currency">Moneda</option>
                            <option value="text">Texto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Posición</label>
                        <input type="number" id="configPosicion" class="form-control" 
                               min="1" max="10" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">¿Qué datos quieres mostrar? *</label>
                    <div id="tipoEstadistica">
                        <div class="mb-4">
                            <button type="button" onclick="mostrarPlantillas()" class="btn btn-primary w-full">
                                <i class="fas fa-chart-bar mr-2"></i>Datos Disponibles en el Sistema
                            </button>
                        </div>
                        <div class="text-center text-gray-500 mb-2">
                            <small>Selecciona el tipo de información que quieres mostrar en el dashboard</small>
                        </div>
                    </div>
                </div>

                <!-- Plantillas Predefinidas (oculto inicialmente) -->
                <div id="seccionPlantillas" class="form-group" style="display: none;">
                    <label class="form-label">Plantillas Disponibles</label>
                    <div id="plantillasGrid" class="grid grid-cols-1 gap-3" style="max-height: 300px; overflow-y: auto;">
                        <!-- Se cargan dinámicamente -->
                    </div>
                    <button type="button" onclick="ocultarPlantillas()" class="btn btn-secondary mt-2">
                        <i class="fas fa-arrow-left mr-2"></i>Volver
                    </button>
                </div>

                <!-- Campos ocultos para almacenar las consultas -->
                <input type="hidden" id="configQuerySql" value="">
                <input type="hidden" id="configCrecimientoQuery" value="">

                <div class="form-group">
                    <label class="form-label">Texto de Crecimiento</label>
                    <input type="text" id="configCrecimientoTexto" class="form-control" 
                           placeholder="Que la semana pasada" value="Que la semana pasada">
                </div>

                <div class="form-group">
                    <label class="flex items-center">
                        <input type="checkbox" id="configActivo" checked class="mr-2">
                        <span class="form-label mb-0">Estadística Activa</span>
                    </label>
                </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="cerrarModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button type="button" onclick="probarConfiguracion()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">
                                <i class="fas fa-flask mr-2"></i>Probar
                            </button>
                            <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition" style="background-color: #C7252B;">
                                <i class="fas fa-save mr-2"></i>Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <script>
        // Variables globales
        let configuraciones = [];
        let plantillasDisponibles = [];
        let tablaSeleccionada = null;
        let opcionesTabla = null;
        let modoEdicion = false;
        let estadisticasActuales = [];
        
        const iconos = [
            'fas fa-users', 'fas fa-building', 'fas fa-chart-bar', 'fas fa-calendar-alt',
            'fas fa-tags', 'fas fa-file-alt', 'fas fa-star', 'fas fa-heart',
            'fas fa-trophy', 'fas fa-gift', 'fas fa-envelope', 'fas fa-phone',
            'fas fa-globe', 'fas fa-cog', 'fas fa-shield-alt', 'fas fa-lock',
            'fas fa-eye', 'fas fa-download', 'fas fa-upload', 'fas fa-thumbs-up'
        ];

        // Actualizar estadísticas del dashboard
        function actualizarEstadisticasDashboard() {
            // Contar estadísticas activas
            const activas = configuraciones.filter(c => c.activo).length;
            document.getElementById('totalEstadisticas').textContent = activas;

            // Contar consultas correctas vs con errores
            let correctas = 0;
            let conErrores = 0;

            estadisticasActuales.forEach(stat => {
                if (stat.error) {
                    conErrores++;
                } else {
                    correctas++;
                }
            });

            document.getElementById('consultasCorrectas').textContent = correctas;
            document.getElementById('consultasError').textContent = conErrores;
            document.getElementById('ultimaActualizacion').textContent = new Date().toLocaleTimeString();
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguraciones();
            actualizarVistaPrevia();
            inicializarIconos();
            inicializarColores();

            document.getElementById('formularioConfiguracion').addEventListener('submit', guardarConfiguracion);
        });

        // Cargar configuraciones existentes
        async function cargarConfiguraciones() {
            try {
                // Agregar timestamp para evitar caché
                const timestamp = Date.now();
                const response = await fetch(`./api/estadisticas-config.php?t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    configuraciones = data.data || [];
                    renderTablaConfiguraciones();
                    
                    if (configuraciones.length === 0) {
                        mostrarNotificacion('No hay configuraciones. Se crearán automáticamente las predeterminadas.', 'info');
                    }
                } else {
                    console.error('Error API:', data);
                    
                    // Si es error de duplicado, intentar resetear
                    if (data.message && data.message.includes('Duplicate entry')) {
                        mostrarNotificacion('Detectado error de datos duplicados. Resolviendo...', 'info');
                        await resolverErrorDuplicado();
                    } else {
                        mostrarNotificacion('Error al cargar configuraciones: ' + data.message, 'error');
                        mostrarOpcionesRecuperacion();
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión: ' + error.message, 'error');
                mostrarOpcionesRecuperacion();
            }
        }

        // Resolver error de duplicado automáticamente
        async function resolverErrorDuplicado() {
            try {
                const response = await fetch('./api/reset-estadisticas.php?action=info');
                const data = await response.json();
                
                if (data.success) {
                    mostrarNotificacion(`Encontrados ${data.total_registros} registros existentes. Sistema funcionando correctamente.`, 'success');
                    // Cargar configuraciones normalmente
                    const configResponse = await fetch('./api/estadisticas-config.php');
                    const configData = await configResponse.json();
                    
                    if (configData.success) {
                        configuraciones = configData.data || [];
                        renderTablaConfiguraciones();
                    }
                }
            } catch (error) {
                console.error('Error resolviendo duplicado:', error);
                mostrarOpcionesRecuperacion();
            }
        }

        // Mostrar opciones de recuperación
        function mostrarOpcionesRecuperacion() {
            const container = document.getElementById('tablaConfiguracionesBody');
            container.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8">
                        <div class="text-red-500 mb-4">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <h3 class="text-lg font-bold">Error cargando configuraciones</h3>
                            <p class="text-gray-600 mt-2">Hay un problema con la base de datos de estadísticas</p>
                        </div>
                        <div class="space-x-3">
                            <button onclick="resetearSistema()" class="btn btn-warning">
                                <i class="fas fa-refresh mr-2"></i>Resetear Sistema
                            </button>
                            <button onclick="cargarConfiguraciones()" class="btn btn-primary">
                                <i class="fas fa-retry mr-2"></i>Reintentar
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Resetear sistema de estadísticas
        async function resetearSistema() {
            if (!confirm('¿Estás seguro de que quieres resetear el sistema de estadísticas?\n\nEsto eliminará todas las configuraciones personalizadas y restaurará las predeterminadas.')) {
                return;
            }

            try {
                mostrarNotificacion('Reseteando sistema...', 'info');
                
                const response = await fetch('./api/reset-estadisticas.php?action=reset');
                const data = await response.json();
                
                if (data.success) {
                    mostrarNotificacion('Sistema reseteado correctamente', 'success');
                    await cargarConfiguraciones();
                    await actualizarVistaPrevia();
                } else {
                    mostrarNotificacion('Error reseteando sistema: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión al resetear', 'error');
            }
        }

        // Renderizar tabla de configuraciones
        function renderTablaConfiguraciones() {
            const tbody = document.getElementById('tablaConfiguracionesBody');
            
            if (configuraciones.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-database text-4xl mb-4"></i>
                            <p>No hay configuraciones de estadísticas</p>
                            <button onclick="abrirModalNueva()" class="btn btn-primary mt-4">
                                <i class="fas fa-plus mr-2"></i>Crear Primera Estadística
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = configuraciones.map(config => `
                <tr>
                    <td>
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-sm font-bold">
                            ${config.posicion}
                        </span>
                    </td>
                    <td>
                        <div>
                            <div class="font-semibold">${config.titulo}</div>
                            <div class="text-sm text-gray-500">${config.descripcion || ''}</div>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center mr-2">
                                <i class="${config.icono} text-gray-600"></i>
                            </div>
                            <small class="text-gray-500">${config.icono}</small>
                        </div>
                    </td>
                    <td>
                        <div class="w-6 h-6 rounded ${getColorClass(config.color)}"></div>
                    </td>
                    <td>
                        <span class="capitalize">${config.formato}</span>
                    </td>
                    <td>
                        <span class="badge ${config.activo ? 'badge-success' : 'badge-danger'}">
                            ${config.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <div class="flex space-x-1">
                            <button onclick="editarConfiguracion(${config.id})" 
                                    class="btn btn-sm bg-blue-500 text-white hover:bg-blue-600 transition-colors" 
                                    title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="duplicarConfiguracion(${config.id})" 
                                    class="btn btn-sm bg-green-500 text-white hover:bg-green-600 transition-colors" 
                                    title="Duplicar">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="confirmarEliminarConfiguracion(${config.id}, '${config.titulo}')" 
                                    class="btn btn-sm bg-red-500 text-white hover:bg-red-600 transition-colors" 
                                    title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Obtener clase CSS para color
        function getColorClass(color) {
            const colors = {
                'blue': 'bg-blue-500',
                'green': 'bg-green-500',
                'orange': 'bg-orange-500',
                'purple': 'bg-purple-500',
                'red': 'bg-red-500'
            };
            return colors[color] || 'bg-gray-500';
        }

        // Actualizar vista previa
        async function actualizarVistaPrevia() {
            const preview = document.getElementById('estadisticasPreview');
            preview.innerHTML = '<div class="col-span-full text-center"><div class="loading"></div> Cargando estadísticas...</div>';
            
            try {
                // Agregar timestamp para evitar caché
                const timestamp = Date.now();
                const response = await fetch(`./api/estadisticas-config.php?accion=valores&t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    estadisticasActuales = data.valores || [];
                    renderEstadisticasPreview(estadisticasActuales);
                    actualizarEstadisticasDashboard();
                } else {
                    preview.innerHTML = `<div class="col-span-full text-center text-red-500">Error: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                preview.innerHTML = '<div class="col-span-full text-center text-red-500">Error de conexión</div>';
            }
        }

        // Renderizar estadísticas en vista previa
        function renderEstadisticasPreview(estadisticas) {
            const preview = document.getElementById('estadisticasPreview');
            
            if (!estadisticas || estadisticas.length === 0) {
                preview.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-chart-line text-4xl mb-4"></i>
                        <p>No hay estadísticas configuradas</p>
                    </div>
                `;
                return;
            }

            preview.innerHTML = estadisticas.map((stat, index) => {
                // Manejar casos donde el valor puede ser null, undefined o tener error
                let valorMostrado = '';
                let claseError = '';
                let mensajeError = '';
                
                if (stat.error) {
                    console.error(`Error en estadística ${stat.nombre}: ${stat.error}`);
                    if (stat.valor !== null && stat.valor !== undefined) {
                        valorMostrado = formatearValor(stat.valor, stat.formato);
                        mensajeError = `<br><small class="text-yellow-600">⚠️ ${stat.error}</small>`;
                        claseError = 'border-l-4 border-yellow-400';
                    } else {
                        valorMostrado = '<span class="text-red-500">Error</span>';
                        mensajeError = `<br><small class="text-red-500">${stat.error}</small>`;
                        claseError = 'border-l-4 border-red-400';
                    }
                } else {
                    valorMostrado = formatearValor(stat.valor, stat.formato);
                }
                
                return `
                    <div class="stat-card ${stat.color} ${modoEdicion ? 'cursor-pointer hover:ring-2 hover:ring-blue-300' : ''} ${claseError}"
                         onclick="${modoEdicion ? `editarEstadisticaDirecta('${stat.nombre}')` : ''}"
                         data-stat-name="${stat.nombre}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-gray-600 text-sm font-medium">${stat.titulo}</p>
                                    <button onclick="eliminarEstadistica('${stat.nombre}', event)"
                                            class="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-all"
                                            title="Eliminar estadística">
                                        <i class="fas fa-trash-alt text-xs"></i>
                                    </button>
                                </div>
                                <div class="stat-number">${valorMostrado}</div>
                                <p class="text-xs text-gray-500">
                                    ${!stat.error ? `${stat.crecimiento > 0 ? '+' : ''}${stat.crecimiento} ${stat.crecimiento_texto}` : 'Datos no disponibles'}
                                    ${mensajeError}
                                </p>
                                ${modoEdicion ? `
                                    <div class="mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                                            <i class="fas fa-edit mr-1"></i> Click para editar
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="stat-icon ${getIconBgClass(stat.color)}">
                                <i class="${stat.icono}"></i>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Formatear valor según tipo
        function formatearValor(valor, formato) {
            switch (formato) {
                case 'percentage':
                    return valor + '%';
                case 'currency':
                    return '$' + Number(valor).toLocaleString();
                case 'number':
                default:
                    return Number(valor).toLocaleString();
            }
        }

        // Obtener clase de fondo para icono
        function getIconBgClass(color) {
            const colors = {
                'blue': 'bg-blue-500',
                'green': 'bg-green-500',
                'orange': 'bg-orange-500',
                'purple': 'bg-purple-500',
                'red': 'bg-red-500'
            };
            return colors[color] || 'bg-gray-500';
        }

        // Inicializar iconos en modal
        async function inicializarIconos() {
            try {
                // Obtener iconos desde la API
                const response = await fetch('./api/estadisticas-opciones.php?action=options');
                const data = await response.json();
                
                if (data.success && data.data.iconos) {
                    const iconosDisponibles = data.data.iconos;
                    const iconGrid = document.getElementById('iconGrid');
                    
                    // Agrupar iconos por categoría
                    const categorias = {};
                    iconosDisponibles.forEach(icono => {
                        if (!categorias[icono.category]) {
                            categorias[icono.category] = [];
                        }
                        categorias[icono.category].push(icono);
                    });
                    
                    let html = '';
                    Object.keys(categorias).forEach(categoria => {
                        html += `<div class="col-span-full text-xs font-semibold text-gray-600 uppercase mb-2 mt-3">${categoria}</div>`;
                        categorias[categoria].forEach(icono => {
                            html += `
                                <div class="icon-option bg-gray-50 hover:bg-blue-50 border-2 border-transparent hover:border-blue-300" 
                                     data-icon="${icono.value}" 
                                     onclick="seleccionarIcono('${icono.value}')"
                                     title="${icono.value}">
                                    <i class="${icono.value} text-gray-600"></i>
                                </div>
                            `;
                        });
                    });
                    
                    iconGrid.innerHTML = html;
                } else {
                    // Fallback a iconos predeterminados si la API falla
                    const iconGrid = document.getElementById('iconGrid');
                    iconGrid.innerHTML = iconos.map(icono => `
                        <div class="icon-option bg-gray-50 hover:bg-blue-50 border-2 border-transparent hover:border-blue-300" 
                             data-icon="${icono}" 
                             onclick="seleccionarIcono('${icono}')"
                             title="${icono}">
                            <i class="${icono} text-gray-600"></i>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error cargando iconos:', error);
                // Usar iconos predeterminados
                const iconGrid = document.getElementById('iconGrid');
                iconGrid.innerHTML = iconos.map(icono => `
                    <div class="icon-option bg-gray-50 hover:bg-blue-50 border-2 border-transparent hover:border-blue-300" 
                         data-icon="${icono}" 
                         onclick="seleccionarIcono('${icono}')"
                         title="${icono}">
                        <i class="${icono} text-gray-600"></i>
                    </div>
                `).join('');
            }
        }

        // Seleccionar icono
        function seleccionarIcono(icono) {
            document.querySelectorAll('.icon-option').forEach(el => {
                el.classList.remove('selected');
                el.classList.remove('border-blue-500', 'bg-blue-100');
            });
            const selectedElement = document.querySelector(`[data-icon="${icono}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected', 'border-blue-500', 'bg-blue-100');
            }
            document.getElementById('configIcono').value = icono;
        }

        // Inicializar opciones de color
        function inicializarColores() {
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    seleccionarColor(this.dataset.color);
                });
            });
        }

        // Seleccionar color
        function seleccionarColor(color) {
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.remove('selected');
                el.style.transform = 'scale(1)';
                el.style.border = '2px solid #e1e5e9';
            });
            
            const selectedElement = document.querySelector(`.color-option[data-color="${color}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
                selectedElement.style.transform = 'scale(1.1)';
                selectedElement.style.border = '3px solid var(--primary-color)';
            }
            
            document.getElementById('configColor').value = color;
        }

        // Abrir modal para nueva configuración
        function abrirModalNueva() {
            document.getElementById('modalTitulo').textContent = 'Nueva Estadística';
            document.getElementById('formularioConfiguracion').reset();
            document.getElementById('configId').value = '';
            document.getElementById('configActivo').checked = true;
            
            // Inicializar iconos y colores
            inicializarIconos().then(() => {
                // Seleccionar primer icono por defecto después de cargarlos
                if (iconos.length > 0) {
                    seleccionarIcono(iconos[0]);
                }
            });
            
            // Seleccionar color azul por defecto
            seleccionarColor('blue');
            
            document.getElementById('modalConfiguracion').classList.remove('hidden');
            document.getElementById('modalConfiguracion').style.display = 'flex';
        }

        // Editar configuración existente
        function editarConfiguracion(id) {
            const config = configuraciones.find(c => c.id == id);
            if (!config) return;

            document.getElementById('modalTitulo').textContent = 'Editar Estadística';
            document.getElementById('configId').value = config.id;
            document.getElementById('configNombre').value = config.nombre;
            document.getElementById('configTitulo').value = config.titulo;
            document.getElementById('configDescripcion').value = config.descripcion || '';
            document.getElementById('configQuerySql').value = config.query_sql;
            document.getElementById('configFormato').value = config.formato;
            document.getElementById('configPosicion').value = config.posicion;
            document.getElementById('configActivo').checked = config.activo == 1;
            document.getElementById('configCrecimientoQuery').value = config.crecimiento_query || '';
            document.getElementById('configCrecimientoTexto').value = config.crecimiento_texto || '';
            
            // Inicializar iconos y seleccionar el del config
            inicializarIconos().then(() => {
                seleccionarIcono(config.icono);
            });
            seleccionarColor(config.color);
            
            // Permitir edición del nombre interno
            document.getElementById('configNombre').disabled = false;
            
            document.getElementById('modalConfiguracion').classList.remove('hidden');
            document.getElementById('modalConfiguracion').style.display = 'flex';
        }

        // Duplicar configuración
        function duplicarConfiguracion(id) {
            const config = configuraciones.find(c => c.id == id);
            if (!config) return;

            document.getElementById('modalTitulo').textContent = 'Duplicar Estadística';
            document.getElementById('configId').value = '';
            document.getElementById('configNombre').value = config.nombre + '_copia';
            document.getElementById('configTitulo').value = config.titulo + ' (Copia)';
            document.getElementById('configDescripcion').value = config.descripcion || '';
            document.getElementById('configQuerySql').value = config.query_sql;
            document.getElementById('configFormato').value = config.formato;
            document.getElementById('configPosicion').value = parseInt(config.posicion) + 1;
            document.getElementById('configActivo').checked = false;
            document.getElementById('configCrecimientoQuery').value = config.crecimiento_query || '';
            document.getElementById('configCrecimientoTexto').value = config.crecimiento_texto || '';
            
            // Inicializar iconos y seleccionar el del config
            inicializarIconos().then(() => {
                seleccionarIcono(config.icono);
            });
            seleccionarColor(config.color);
            
            // Habilitar nombre para duplicación
            document.getElementById('configNombre').disabled = false;
            
            document.getElementById('modalConfiguracion').classList.remove('hidden');
            document.getElementById('modalConfiguracion').style.display = 'flex';
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modalConfiguracion').classList.add('hidden');
            document.getElementById('modalConfiguracion').style.display = 'none';
            if (document.getElementById('configNombre')) {
                document.getElementById('configNombre').disabled = false;
            }
        }

        // Guardar configuración
        async function guardarConfiguracion(event) {
            event.preventDefault();
            
            const formData = new FormData();
            const configId = document.getElementById('configId').value;
            
            // Recopilar datos del formulario
            formData.append('nombre', document.getElementById('configNombre').value);
            formData.append('titulo', document.getElementById('configTitulo').value);
            formData.append('descripcion', document.getElementById('configDescripcion').value);
            formData.append('icono', document.getElementById('configIcono').value);
            formData.append('color', document.getElementById('configColor').value);
            formData.append('query_sql', document.getElementById('configQuerySql').value);
            formData.append('formato', document.getElementById('configFormato').value);
            formData.append('posicion', document.getElementById('configPosicion').value);
            formData.append('activo', document.getElementById('configActivo').checked ? 1 : 0);
            formData.append('crecimiento_query', document.getElementById('configCrecimientoQuery').value);
            formData.append('crecimiento_texto', document.getElementById('configCrecimientoTexto').value);

            try {
                const url = configId ? 
                    `./api/estadisticas-config.php?id=${configId}` : 
                    './api/estadisticas-config.php';
                
                const response = await fetch(url, {
                    method: configId ? 'PUT' : 'POST',
                    body: configId ? new URLSearchParams(formData) : formData
                });

                const data = await response.json();

                if (data.success) {
                    mostrarNotificacion(data.message, 'success');
                    cerrarModal();
                    
                    // Esperar un poco para que la base de datos se actualice
                    setTimeout(async () => {
                        await cargarConfiguraciones();
                        await actualizarVistaPrevia();
                        
                        // Actualizar vista previa si está abierta
                        if (document.getElementById('previewContainer')) {
                            await cargarEstadisticasPreview();
                        }
                    }, 500);
                } else {
                    mostrarNotificacion('Error: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión', 'error');
            }
        }

        // Eliminar configuración
        async function eliminarConfiguracion(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta configuración?')) {
                return;
            }

            try {
                const response = await fetch(`./api/estadisticas-config.php?id=${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    mostrarNotificacion(data.message, 'success');
                    await cargarConfiguraciones();
                    await actualizarVistaPrevia();

                    // Actualizar vista previa si está abierta
                    if (document.getElementById('previewContainer')) {
                        await cargarEstadisticasPreview();
                    }
                } else {
                    mostrarNotificacion('Error: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión', 'error');
            }
        }

        // Eliminar estadística individual desde la vista previa
        async function eliminarEstadistica(nombre, event) {
            // Prevenir el evento click del contenedor padre
            if (event) {
                event.stopPropagation();
            }

            if (!confirm(`¿Estás seguro de que quieres eliminar la estadística "${nombre}"?`)) {
                return;
            }

            try {
                // Buscar el ID de configuración por el nombre
                const estadistica = estadisticasActuales.find(stat => stat.nombre === nombre);

                if (!estadistica || !estadistica.config_id) {
                    mostrarNotificacion('No se pudo encontrar la configuración de esta estadística', 'error');
                    return;
                }

                const response = await fetch(`./api/estadisticas-config.php?id=${estadistica.config_id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    mostrarNotificacion(`Estadística "${nombre}" eliminada correctamente`, 'success');

                    // Recargar configuraciones y vista previa
                    await cargarConfiguraciones();
                    await cargarEstadisticasPreview();

                    // Actualizar el dashboard también
                    await actualizarEstadisticasDashboard();
                } else {
                    mostrarNotificacion('Error al eliminar: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando estadística:', error);
                mostrarNotificacion('Error de conexión al eliminar la estadística', 'error');
            }
        }

        // Probar configuración antes de guardar
        async function probarConfiguracion() {
            const querySql = document.getElementById('configQuerySql').value;
            const crecimientoQuery = document.getElementById('configCrecimientoQuery').value;
            
            if (!querySql.trim()) {
                mostrarNotificacion('Ingresa una consulta SQL para probar', 'error');
                return;
            }

            try {
                // Simular prueba ejecutando la consulta
                await ejecutarConsulta(querySql);
                
                if (crecimientoQuery.trim()) {
                    await ejecutarConsulta(crecimientoQuery);
                }
                
                mostrarNotificacion('¡Consultas validadas correctamente!', 'success');
            } catch (error) {
                mostrarNotificacion('Error en consultas: ' + error.message, 'error');
            }
        }

        // Probar consulta en el probador
        async function probarConsulta() {
            const query = document.getElementById('queryTester').value;
            if (!query.trim()) {
                mostrarNotificacion('Ingresa una consulta para probar', 'error');
                return;
            }

            const resultDiv = document.getElementById('queryResult');
            resultDiv.innerHTML = '<div class="loading"></div> Ejecutando consulta...';

            try {
                const result = await ejecutarConsulta(query);
                resultDiv.innerHTML = `
                    <div class="text-green-600 mb-2">
                        <i class="fas fa-check-circle mr-2"></i>Consulta ejecutada exitosamente
                    </div>
                    <pre class="bg-gray-100 p-3 rounded text-sm overflow-x-auto">${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}
                    </div>
                `;
            }
        }

        // Ejecutar consulta real en la base de datos
        async function ejecutarConsulta(query) {
            try {
                const response = await fetch('./api/test-query.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.result;
                } else {
                    throw new Error(data.message || 'Error ejecutando consulta');
                }
            } catch (error) {
                console.error('Error ejecutando consulta:', error);
                throw new Error(`Error ejecutando consulta: ${error.message}`);
            }
        }

        // Limpiar consulta
        function limpiarConsulta() {
            document.getElementById('queryTester').value = '';
            document.getElementById('queryResult').innerHTML = `
                <div class="text-center text-gray-500">
                    <i class="fas fa-play-circle text-2xl mb-2"></i>
                    <p>Ejecuta una consulta para ver el resultado</p>
                </div>
            `;
        }

        // Previsualizar en dashboard
        function previsualizarDashboard() {
            // Crear modal de previsualización
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    max-width: 95vw;
                    max-height: 95vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: between-space; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                        <div>
                            <h3 style="margin: 0; color: var(--primary-color); font-size: 1.5rem;">
                                <i class="fas fa-eye mr-2"></i>Vista Previa: Dashboard
                            </h3>
                            <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                                Así se verán las estadísticas en el dashboard principal
                            </p>
                        </div>
                        <button onclick="cerrarVistaPrevia()" 
                                style="background: none; border: none; font-size: 1.5rem; color: #999; cursor: pointer; position: absolute; top: 1rem; right: 1rem; z-index: 1000;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="dashboard-preview" style="padding: 1rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px;">
                        <div class="dashboard-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; text-align: center;">
                            <h2 style="margin: 0; font-size: 1.8rem;">
                                <i class="fas fa-tachometer-alt mr-2"></i>Dashboard Principal
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Vista previa de estadísticas dinámicas</p>
                        </div>
                        
                        <div id="previewContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div style="text-center; color: #666; grid-column: 1 / -1;">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Cargando estadísticas...</p>
                            </div>
                        </div>
                        
                        <div style="text-center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
                            <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                                <button onclick="corregirConsultasDesdePreview()" class="btn btn-warning">
                                    <i class="fas fa-tools mr-2"></i>Corregir Errores SQL
                                </button>
                                <button onclick="window.open('dashboard.html', '_blank')" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt mr-2"></i>Ver Dashboard Real
                                </button>
                                <button onclick="cerrarVistaPrevia()" class="btn btn-secondary">
                                    <i class="fas fa-times mr-2"></i>Cerrar Vista Previa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cargar estadísticas para la previsualización
            cargarEstadisticasPreview();
        }

        // Cargar estadísticas para previsualización
        async function cargarEstadisticasPreview() {
            try {
                // Usar la misma URL que la función principal con anti-caché
                const timestamp = Date.now();
                const response = await fetch(`./api/estadisticas-config.php?accion=valores&t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                const container = document.getElementById('previewContainer');
                
                if (data.success && data.valores && data.valores.length > 0) {
                    container.innerHTML = data.valores.map((stat, index) => {
                        // Mejor manejo de errores y valores
                        let valor, crecimiento, statusClass = '';
                        
                        if (stat.error) {
                            valor = '<span style="color: #e74c3c; font-size: 1rem;">Error SQL</span>';
                            crecimiento = 'Consulta necesita corrección';
                            statusClass = 'error';
                        } else {
                            valor = formatearValor(stat.valor || 0, stat.formato);
                            crecimiento = stat.crecimiento_texto ? 
                                `${stat.crecimiento > 0 ? '+' : ''}${stat.crecimiento || 0} ${stat.crecimiento_texto}` : 
                                `Valor actual: ${stat.valor || 0}`;
                        }
                        
                        return `
                            <div class="stat-card ${stat.color} ${statusClass}" style="
                                background: white;
                                border-radius: 16px;
                                padding: 1.5rem;
                                box-shadow: 0 4px 20px rgba(199, 37, 43, 0.1);
                                transition: all 0.3s ease;
                                border: 1px solid ${stat.error ? '#e74c3c' : 'rgba(199, 37, 43, 0.1)'};
                                position: relative;
                                overflow: hidden;
                                animation: fadeInUp 0.6s ease-out;
                                animation-delay: ${index * 0.1}s;
                                animation-fill-mode: both;
                            ">
                                <div style="
                                    content: '';
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 4px;
                                    height: 100%;
                                    background: ${stat.error ? 'linear-gradient(to bottom, #e74c3c, #c0392b)' : getColorGradient(stat.color)};
                                "></div>
                                
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="flex: 1;">
                                        <p style="color: #666; font-size: 0.875rem; font-weight: 500; margin: 0 0 0.5rem 0;">${stat.titulo}</p>
                                        <div style="font-size: 2rem; font-weight: 800; color: ${stat.error ? '#e74c3c' : 'var(--primary-color)'}; margin: 0.5rem 0;">${valor}</div>
                                        <p style="font-size: 0.75rem; color: ${stat.error ? '#e74c3c' : '#999'}; margin: 0;">${crecimiento}</p>
                                        ${stat.error ? `<small style="color: #e74c3c; font-size: 0.7rem; display: block; margin-top: 0.5rem;">💡 Usa "Corregir SQL" para arreglar</small>` : ''}
                                    </div>
                                    <div style="
                                        width: 50px;
                                        height: 50px;
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 1.5rem;
                                        color: white;
                                        background: ${stat.error ? 'linear-gradient(135deg, #e74c3c, #c0392b)' : getIconBackground(stat.color)};
                                        margin-left: 1rem;
                                    ">
                                        <i class="${stat.error ? 'fas fa-exclamation-triangle' : stat.icono}"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-center; color: #999; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <p>No hay estadísticas configuradas</p>
                            <small>Usa "Nueva Estadística" para crear una o "Resetear Datos" para cargar ejemplos básicos</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error cargando preview:', error);
                const container = document.getElementById('previewContainer');
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-center; color: #e74c3c; padding: 2rem;">
                        <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                        <p>Error cargando estadísticas para vista previa</p>
                        <small>${error.message}</small>
                        <br><br>
                        <button onclick="cerrarVistaPrevia()" style="background: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                `;
            }
        }

        // Funciones auxiliares para la previsualización
        function getColorGradient(color) {
            const gradients = {
                'blue': 'linear-gradient(to bottom, #3498DB, #5DADE2)',
                'green': 'linear-gradient(to bottom, #27AE60, #58D68D)',
                'orange': 'linear-gradient(to bottom, #F39C12, #F8C471)',
                'purple': 'linear-gradient(to bottom, #9B59B6, #BB8FCE)',
                'red': 'linear-gradient(to bottom, #E74C3C, #F1948A)'
            };
            return gradients[color] || gradients['blue'];
        }

        function getIconBackground(color) {
            const backgrounds = {
                'blue': 'linear-gradient(135deg, #3498DB, #5DADE2)',
                'green': 'linear-gradient(135deg, #27AE60, #58D68D)',
                'orange': 'linear-gradient(135deg, #F39C12, #F8C471)',
                'purple': 'linear-gradient(135deg, #9B59B6, #BB8FCE)',
                'red': 'linear-gradient(135deg, #E74C3C, #F1948A)'
            };
            return backgrounds[color] || backgrounds['blue'];
        }

        function getGradientClass(color) {
            const gradients = {
                'blue': 'from-blue-500 to-blue-600',
                'green': 'from-green-500 to-green-600',
                'orange': 'from-orange-500 to-orange-600',
                'purple': 'from-purple-500 to-purple-600',
                'red': 'from-red-500 to-red-600'
            };
            return gradients[color] || gradients['blue'];
        }

        // Corregir consultas desde vista previa
        async function corregirConsultasDesdePreview() {
            await corregirConsultas();
            // Recargar la vista previa después de la corrección
            setTimeout(async () => {
                if (document.getElementById('previewContainer')) {
                    await cargarEstadisticasPreview();
                }
            }, 1500);
        }

        // Cerrar vista previa
        function cerrarVistaPrevia() {
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.style.zIndex === '10000' || modal.innerHTML.includes('Vista Previa: Dashboard')) {
                    modal.remove();
                }
            });
        }

        // === SISTEMA DE PLANTILLAS PREDEFINIDAS ===
        
        // Mostrar sección de plantillas
        async function mostrarPlantillas() {
            document.getElementById('tipoEstadistica').style.display = 'none';
            document.getElementById('seccionPlantillas').style.display = 'block';
            
            if (plantillasDisponibles.length === 0) {
                await cargarPlantillas();
            }
            
            renderizarPlantillas();
        }
        
        // Cargar plantillas desde la API
        async function cargarPlantillas() {
            try {
                const response = await fetch('./api/estadisticas-opciones.php?action=templates');
                const data = await response.json();
                
                if (data.success) {
                    plantillasDisponibles = data.templates;
                } else {
                    mostrarNotificacion('Error cargando plantillas: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión al cargar plantillas', 'error');
            }
        }
        
        // Renderizar plantillas en la interfaz
        function renderizarPlantillas() {
            const grid = document.getElementById('plantillasGrid');
            
            if (plantillasDisponibles.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-database text-3xl mb-3"></i>
                        <p>No hay plantillas disponibles</p>
                        <small>Verifica que existan tablas con datos en la base de datos</small>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = plantillasDisponibles.map(template => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-400 cursor-pointer transition-colors hover:shadow-lg" 
                     onclick="seleccionarPlantilla('${template.id}')">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br ${getGradientClass(template.color)} flex items-center justify-center text-white text-lg mr-3 shadow-md">
                                <i class="${template.icono}"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-base text-gray-800">${template.titulo}</h4>
                                <p class="text-sm text-gray-600">${template.descripcion}</p>
                                <div class="mt-1">
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                                        ${template.preview_text || 'Datos disponibles'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-gray-800">${template.preview_value || '?'}</div>
                            <div class="text-xs text-gray-500 uppercase">${template.formato || 'número'}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span><i class="fas fa-database mr-1"></i>${template.tabla || 'Sistema'}</span>
                        <span><i class="fas fa-arrow-right"></i></span>
                    </div>
                </div>
            `).join('');
        }
        
        // Seleccionar una plantilla
        function seleccionarPlantilla(templateId) {
            const template = plantillasDisponibles.find(t => t.id === templateId);
            if (!template) return;
            
            // Llenar campos del formulario
            document.getElementById('configTitulo').value = template.titulo;
            document.getElementById('configDescripcion').value = template.descripcion;
            document.getElementById('configQuerySql').value = template.query_generada || '';
            document.getElementById('configFormato').value = template.formato;
            
            // Seleccionar icono y color
            seleccionarIcono(template.icono);
            seleccionarColor(template.color);
            
            // Generar consulta de crecimiento automática si tiene datos de plantilla
            if (template.crecimiento_query) {
                document.getElementById('configCrecimientoQuery').value = template.crecimiento_query;
            }
            if (template.crecimiento_texto) {
                document.getElementById('configCrecimientoTexto').value = template.crecimiento_texto;
            }
            
            // Ocultar plantillas y mostrar formulario principal
            ocultarPlantillas();
            
            mostrarNotificacion(`Datos seleccionados: "${template.titulo}"`, 'success');
        }
        
        // === CONSTRUCTOR VISUAL ===
        
        // Mostrar constructor visual
        async function mostrarConstructor() {
            document.getElementById('tipoEstadistica').style.display = 'none';
            document.getElementById('seccionConstructor').style.display = 'block';
            
            await cargarTablasDisponibles();
        }
        
        // Cargar tablas disponibles
        async function cargarTablasDisponibles() {
            try {
                const response = await fetch('./api/estadisticas-opciones.php?action=all');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('constructorTabla');
                    select.innerHTML = '<option value="">Seleccionar tabla...</option>';
                    
                    Object.keys(data.opciones).forEach(tabla => {
                        const info = data.opciones[tabla];
                        if (info.tiene_datos) {
                            select.innerHTML += `
                                <option value="${tabla}">
                                    ${tabla} (${info.total_registros} registros)
                                </option>
                            `;
                        }
                    });
                } else {
                    mostrarNotificacion('Error cargando tablas: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión al cargar tablas', 'error');
            }
        }
        
        // Cargar opciones específicas de una tabla
        async function cargarOpcionesTabla() {
            const tabla = document.getElementById('constructorTabla').value;
            if (!tabla) {
                document.getElementById('opcionesFiltro').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`./api/estadisticas-opciones.php?action=table&table=${tabla}`);
                const data = await response.json();
                
                if (data.success) {
                    tablaSeleccionada = tabla;
                    opcionesTabla = data.info;
                    document.getElementById('opcionesFiltro').style.display = 'block';
                    actualizarConstructor();
                } else {
                    mostrarNotificacion('Error cargando información de tabla: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión', 'error');
            }
        }
        
        // Actualizar constructor según selecciones
        function actualizarConstructor() {
            if (!tablaSeleccionada || !opcionesTabla) return;
            
            const tipo = document.getElementById('constructorTipo').value;
            let query = '';
            
            switch (tipo) {
                case 'count':
                    query = `SELECT COUNT(*) as valor FROM \`${tablaSeleccionada}\``;
                    break;
                case 'sum':
                case 'avg':
                case 'max':
                case 'min':
                    // Para estas necesitamos una columna numérica
                    query = `SELECT ${tipo.toUpperCase()}(columna_numerica) as valor FROM \`${tablaSeleccionada}\``;
                    break;
            }
            
            // Agregar filtros si existen
            const filtros = obtenerFiltrosActivos();
            if (filtros.length > 0) {
                query += ' WHERE ' + filtros.join(' AND ');
            }
            
            document.getElementById('queryGenerada').value = query;
        }
        
        // Agregar filtro al constructor
        function agregarFiltro() {
            if (!opcionesTabla) return;
            
            const container = document.getElementById('filtrosContainer');
            const filtroId = 'filtro_' + Date.now();
            
            const filtroHTML = `
                <div class="flex items-center space-x-2" id="${filtroId}">
                    <select class="form-control flex-1" onchange="actualizarConstructor()">
                        <option value="">Seleccionar columna...</option>
                        ${opcionesTabla.columnas.map(col => 
                            `<option value="${col.nombre}">${col.nombre} (${col.tipo})</option>`
                        ).join('')}
                    </select>
                    <select class="form-control" onchange="actualizarConstructor()">
                        <option value="=">Igual a</option>
                        <option value="!=">Diferente de</option>
                        <option value=">">Mayor que</option>
                        <option value="<">Menor que</option>
                        <option value="LIKE">Contiene</option>
                        <option value="IS NOT NULL">No es nulo</option>
                    </select>
                    <input type="text" class="form-control" placeholder="Valor" onchange="actualizarConstructor()">
                    <button type="button" onclick="eliminarFiltro('${filtroId}')" class="btn btn-sm bg-red-500 text-white">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', filtroHTML);
        }
        
        // Eliminar filtro
        function eliminarFiltro(filtroId) {
            document.getElementById(filtroId).remove();
            actualizarConstructor();
        }
        
        // Obtener filtros activos
        function obtenerFiltrosActivos() {
            const filtros = [];
            document.querySelectorAll('#filtrosContainer > div').forEach(div => {
                const selects = div.querySelectorAll('select');
                const input = div.querySelector('input');
                
                if (selects[0].value && selects[1].value) {
                    let valor = input.value;
                    let condicion = `\`${selects[0].value}\` ${selects[1].value}`;
                    
                    if (selects[1].value === 'IS NOT NULL') {
                        filtros.push(condicion);
                    } else if (valor) {
                        if (selects[1].value === 'LIKE') {
                            valor = `'%${valor}%'`;
                        } else if (isNaN(valor)) {
                            valor = `'${valor}'`;
                        }
                        filtros.push(`${condicion} ${valor}`);
                    }
                }
            });
            return filtros;
        }
        
        // Probar query generada
        async function probarQueryGenerada() {
            const query = document.getElementById('queryGenerada').value;
            if (!query.trim()) {
                mostrarNotificacion('No hay consulta para probar', 'error');
                return;
            }
            
            mostrarNotificacion('Probando consulta...', 'info');
            
            // Simular resultado (en implementación real se ejecutaría la query)
            setTimeout(() => {
                const resultado = Math.floor(Math.random() * 1000) + 1;
                mostrarNotificacion(`✅ Consulta válida. Resultado: ${resultado}`, 'success');
            }, 1000);
        }
        
        // Usar query generada
        function usarQueryGenerada() {
            const query = document.getElementById('queryGenerada').value;
            if (!query.trim()) {
                mostrarNotificacion('Genera una consulta primero', 'error');
                return;
            }
            
            // Llenar campo de consulta principal
            document.getElementById('configQuerySql').value = query;
            
            // Generar título automático
            const tabla = tablaSeleccionada;
            const tipo = document.getElementById('constructorTipo').value;
            const titulo = `${tipo === 'count' ? 'Total' : tipo.toUpperCase()} de ${tabla}`;
            
            if (!document.getElementById('configTitulo').value) {
                document.getElementById('configTitulo').value = titulo;
            }
            
            // Generar consulta de crecimiento
            if (opcionesTabla.columnas_fecha.length > 0) {
                const fechaCol = opcionesTabla.columnas_fecha[0];
                const crecimientoQuery = query.replace('FROM', `FROM \`${tabla}\` WHERE \`${fechaCol}\` >= DATE_SUB(NOW(), INTERVAL 7 DAY) FROM`);
                document.getElementById('configCrecimientoQuery').value = crecimientoQuery;
                document.getElementById('configCrecimientoTexto').value = 'Últimos 7 días';
            }
            
            // Mostrar sección de consultas
            ocultarConstructor();
            mostrarSeccionConsultas();
            
            mostrarNotificacion('Consulta aplicada correctamente', 'success');
        }
        
        // === NAVEGACIÓN ENTRE SECCIONES ===
        
        function ocultarPlantillas() {
            document.getElementById('seccionPlantillas').style.display = 'none';
            document.getElementById('tipoEstadistica').style.display = 'block';
        }
        
        function ocultarConstructor() {
            document.getElementById('seccionConstructor').style.display = 'none';
            document.getElementById('tipoEstadistica').style.display = 'block';
        }
        
        function mostrarSeccionConsultas() {
            document.getElementById('tipoEstadistica').style.display = 'none';
            document.getElementById('seccionPlantillas').style.display = 'none';
            document.getElementById('seccionConstructor').style.display = 'none';
            document.getElementById('seccionConsultas').style.display = 'block';
        }
        
        function volverATipos() {
            document.getElementById('seccionConsultas').style.display = 'none';
            document.getElementById('tipoEstadistica').style.display = 'block';
            
            // Limpiar consultas
            document.getElementById('configQuerySql').value = '';
            document.getElementById('configCrecimientoQuery').value = '';
        }
        
        // Generar consulta de crecimiento automática
        function generarConsultaCrecimiento(template) {
            let crecimientoQuery = '';
            let crecimientoTexto = 'Que la semana pasada';
            
            // Intentar generar consulta de crecimiento basada en el tipo
            if (template.tipo === 'total') {
                crecimientoQuery = `SELECT COUNT(*) as valor FROM \`${template.tabla}\` WHERE fecha_creacion >= DATE_SUB(NOW(), INTERVAL 7 DAY)`;
            } else if (template.tipo.includes('fecha')) {
                // Ya tiene filtro de fecha, usar como crecimiento
                crecimientoQuery = template.query_generada;
                crecimientoTexto = 'En el período seleccionado';
            }
            
            document.getElementById('configCrecimientoQuery').value = crecimientoQuery;
            document.getElementById('configCrecimientoTexto').value = crecimientoTexto;
        }

        // === FUNCIONES DE MODO EDICIÓN ===
        
        // Alternar modo edición
        function toggleModoEdicion() {
            modoEdicion = !modoEdicion;
            const btnModoEdicion = document.getElementById('btnModoEdicion');
            const panelEdicion = document.getElementById('panelEdicionRapida');
            
            if (modoEdicion) {
                btnModoEdicion.innerHTML = '<i class="fas fa-times mr-2"></i>Salir Edición';
                btnModoEdicion.className = 'btn btn-danger';
                panelEdicion.style.display = 'block';
                mostrarNotificacion('Modo edición activado. Haz click en cualquier estadística para editarla.', 'info');
            } else {
                salirModoEdicion();
            }
            
            // Re-renderizar estadísticas con/sin controles de edición
            renderEstadisticasPreview(estadisticasActuales);
        }
        
        // Salir del modo edición
        function salirModoEdicion() {
            modoEdicion = false;
            const btnModoEdicion = document.getElementById('btnModoEdicion');
            const panelEdicion = document.getElementById('panelEdicionRapida');
            
            btnModoEdicion.innerHTML = '<i class="fas fa-edit mr-2"></i>Modo Edición';
            btnModoEdicion.className = 'btn btn-warning';
            panelEdicion.style.display = 'none';
            
            // Re-renderizar estadísticas sin controles de edición
            renderEstadisticasPreview(estadisticasActuales);
        }
        
        // Editar estadística directamente
        function editarEstadisticaDirecta(nombre) {
            if (!modoEdicion) return;
            
            // Buscar la configuración en las estadísticas actuales
            const config = configuraciones.find(c => c.nombre === nombre);
            if (config) {
                editarConfiguracion(config.id);
            } else {
                mostrarNotificacion('No se encontró la configuración para esta estadística', 'error');
            }
        }
        
        // Modificar todas las estadísticas
        function modificarTodasLasEstadisticas() {
            mostrarNotificacion('Función en desarrollo...', 'info');
        }
        
        // Resetear estadísticas a predeterminadas
        async function resetearEstadisticasDefecto() {
            if (!confirm('¿Estás seguro de que quieres restaurar todas las estadísticas a sus valores predeterminados?\n\nEsto eliminará todas las configuraciones personalizadas.')) {
                return;
            }
            
            try {
                mostrarNotificacion('Restaurando estadísticas predeterminadas...', 'info');
                
                // Eliminar todas las configuraciones existentes
                for (const config of configuraciones) {
                    await fetch(`./api/estadisticas-config.php?id=${config.id}`, {
                        method: 'DELETE'
                    });
                }
                
                // Recargar todo
                await cargarConfiguraciones();
                await actualizarVistaPrevia();
                
                mostrarNotificacion('Estadísticas restauradas a valores predeterminados', 'success');
                salirModoEdicion();
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al restaurar estadísticas', 'error');
            }
        }
        
        // Aplicar cambios (para futuras funcionalidades de reordenamiento)
        function aplicarCambios() {
            mostrarNotificacion('Cambios aplicados correctamente', 'success');
            salirModoEdicion();
        }

        // Resetear estadísticas con datos correctos
        async function resetearEstadisticas() {
            if (!confirm('¿Estás seguro de que quieres resetear las estadísticas?\n\nEsto eliminará las configuraciones actuales y las reemplazará con datos básicos que funcionan.')) {
                return;
            }

            try {
                mostrarNotificacion('Reseteando estadísticas...', 'info');
                
                const response = await fetch('./api/reset-estadisticas.php?action=reset');
                const data = await response.json();
                
                if (data.success) {
                    mostrarNotificacion('Estadísticas reseteadas correctamente', 'success');
                    await cargarConfiguraciones();
                    await actualizarVistaPrevia();
                } else {
                    mostrarNotificacion('Error reseteando estadísticas: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error de conexión al resetear', 'error');
            }
        }

        // Corregir consultas SQL problemáticas
        async function corregirConsultas() {
            if (!confirm('¿Quieres corregir automáticamente las consultas SQL con errores?\n\nEsto actualizará las consultas para que funcionen correctamente.')) {
                return;
            }

            try {
                mostrarNotificacion('Corrigiendo consultas SQL...', 'info');
                
                // Obtener estadísticas actuales para identificar cuáles tienen errores
                const debugResponse = await fetch('./api/debug-estadisticas.php');
                const debugData = await debugResponse.json();
                
                if (!debugData.success) {
                    throw new Error('Error obteniendo información de debug');
                }
                
                // Identificar consultas con errores y corregirlas
                const correcciones = [];
                
                for (const config of debugData.data.configuraciones_debug) {
                    if (config.error) {
                        let nuevaQuery = null;
                        let nuevoTitulo = config.titulo;
                        let nuevaDescripcion = '';
                        
                        // Correcciones específicas basadas en los errores encontrados
                        if (config.error.includes("Unknown column 'activo'")) {
                            // Quitar filtro WHERE activo = 1
                            nuevaQuery = config.query_sql.replace(/ WHERE activo = 1/g, '');
                            nuevaDescripcion = 'Total de registros (sin filtro de activo)';
                        } else if (config.error.includes("Unknown column 'columna_numerica'")) {
                            // Cambiar SUM por COUNT
                            nuevaQuery = config.query_sql.replace(/SUM\(columna_numerica\)/g, 'COUNT(*)');
                            nuevaDescripcion = 'Total de registros';
                        } else if (config.error.includes("syntax error") && config.query_sql.includes('>=')) {
                            // Corregir sintaxis de fecha
                            nuevaQuery = config.query_sql.replace(/&gt;=/g, '>=');
                            nuevaDescripcion = 'Registros recientes';
                        }
                        
                        if (nuevaQuery) {
                            correcciones.push({
                                id: config.id,
                                query_sql: nuevaQuery,
                                titulo: nuevoTitulo,
                                descripcion: nuevaDescripcion
                            });
                        }
                    }
                }
                
                if (correcciones.length === 0) {
                    mostrarNotificacion('No se encontraron consultas que corregir', 'info');
                    return;
                }
                
                // Aplicar correcciones una por una
                let corregidas = 0;
                for (const correccion of correcciones) {
                    try {
                        const formData = new FormData();
                        formData.append('query_sql', correccion.query_sql);
                        formData.append('titulo', correccion.titulo);
                        formData.append('descripcion', correccion.descripcion);
                        
                        const response = await fetch(`./api/estadisticas-config.php?id=${correccion.id}`, {
                            method: 'PUT',
                            body: new URLSearchParams(formData)
                        });
                        
                        if (response.ok) {
                            corregidas++;
                        }
                    } catch (e) {
                        console.error('Error corrigiendo estadística:', e);
                    }
                }
                
                mostrarNotificacion(`Se corrigieron ${corregidas} consultas SQL`, 'success');
                
                // Actualizar la vista
                setTimeout(async () => {
                    await cargarConfiguraciones();
                    await actualizarVistaPrevia();
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error corrigiendo consultas: ' + error.message, 'error');
            }
        }

        // Confirmar eliminación de estadística
        function confirmarEliminarConfiguracion(id, titulo) {
            if (confirm(`¿Estás seguro de que quieres eliminar la estadística "${titulo}"?\n\nEsta acción no se puede deshacer.`)) {
                eliminarConfiguracion(id);
            }
        }

        // Mostrar notificación
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = mensaje;
            notification.className = `notification ${tipo} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>

    </div>

    <script>
        // === SIDEBAR RETRACTABLE FUNCTIONALITY ===
        function initializeSidebar() {
            const sidebar = document.querySelector('.porsche-sidebar');
            const overlay = document.getElementById('sidenavOverlay');
            const hamburgerBtn = document.querySelector('[sidenav-trigger]');
            const closeBtn = document.getElementById('sidebarCloseBtn');

            console.log('Sidebar elements:', {
                sidebar: !!sidebar,
                overlay: !!overlay,
                hamburgerBtn: !!hamburgerBtn,
                closeBtn: !!closeBtn,
                screenWidth: window.innerWidth,
                isDesktop: window.innerWidth >= 1280
            });

            // Log computed styles for debugging
            if (sidebar) {
                const styles = window.getComputedStyle(sidebar);
                console.log('Sidebar computed styles:', {
                    display: styles.display,
                    transform: styles.transform,
                    left: styles.left,
                    position: styles.position,
                    zIndex: styles.zIndex
                });
            }

            if (!sidebar || !overlay || !hamburgerBtn) {
                console.error('Sidebar elements not found:', {
                    sidebar: !!sidebar,
                    overlay: !!overlay,
                    hamburgerBtn: !!hamburgerBtn
                });
                return;
            }

            // Toggle sidebar function
            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const isVisible = sidebar.classList.contains('sidenav-show');
                console.log('Toggle sidebar - currently visible:', isVisible);
                if (!isVisible) {
                    // Open sidebar
                    console.log('Opening sidebar');
                    sidebar.classList.add('sidenav-show');
                    sidebar.setAttribute('aria-expanded', 'true');
                    overlay.classList.add('show');
                    document.body.style.overflow = 'hidden';
                    // Focus management for accessibility
                    const firstLink = sidebar.querySelector('.porsche-nav-item');
                    if (firstLink) {
                        setTimeout(() => firstLink.focus(), 100);
                    }
                } else {
                    // Close sidebar
                    console.log('Closing sidebar');
                    closeSidebarInternal();
                }
            }

            // Close sidebar function
            function closeSidebarInternal() {
                console.log('Executing closeSidebarInternal');
                sidebar.classList.remove('sidenav-show');
                sidebar.setAttribute('aria-expanded', 'false');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
                // Return focus to hamburger button
                if (hamburgerBtn) {
                    hamburgerBtn.focus();
                }
            }

            // Event listeners
            console.log('Adding click event to hamburger button');
            hamburgerBtn.addEventListener('click', toggleSidebar);
            hamburgerBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleSidebar(e);
            }, { passive: false });

            if (overlay) {
                overlay.addEventListener('click', closeSidebarInternal);
                overlay.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    closeSidebarInternal();
                }, { passive: false });
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSidebarInternal();
                });
                closeBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSidebarInternal();
                }, { passive: false });
            }

            // Close on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSidebarInternal();
                }
            });

            // Handle window resize - Keep sidebar closed on all screen sizes
            window.addEventListener('resize', function() {
                // Optional: could add logic here if needed
            });

            // Swipe to close functionality
            let touchStartX = 0;
            let touchStartY = 0;
            sidebar.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            sidebar.addEventListener('touchmove', function(e) {
                if (!touchStartX) return;
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = touchStartX - currentX;
                const diffY = Math.abs(touchStartY - currentY);

                // Swipe left to close
                if (diffX > 50 && diffY < 100) {
                    closeSidebarInternal();
                    touchStartX = 0;
                    touchStartY = 0;
                }
            }, { passive: true });

            // Keyboard navigation in sidebar
            sidebar.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSidebarInternal();
                }
                // Arrow navigation
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    const navItems = Array.from(sidebar.querySelectorAll('.porsche-nav-item:not([style*="display: none"])'));
                    const currentIndex = navItems.indexOf(document.activeElement);
                    if (e.key === 'ArrowDown') {
                        const nextIndex = (currentIndex + 1) % navItems.length;
                        navItems[nextIndex].focus();
                    } else {
                        const prevIndex = currentIndex <= 0 ? navItems.length - 1 : currentIndex - 1;
                        navItems[prevIndex].focus();
                    }
                }
            });

            console.log('✅ Sidebar functionality initialized successfully');
        }

        // Legacy function compatibility
        function closeSidebar() {
            const sidebar = document.querySelector('.porsche-sidebar');
            const overlay = document.getElementById('sidenavOverlay');
            if (sidebar && overlay) {
                sidebar.classList.remove('sidenav-show');
                sidebar.setAttribute('aria-expanded', 'false');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Initialize sidebar when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeSidebar, 100);
        });
    </script>
</body>
</html>